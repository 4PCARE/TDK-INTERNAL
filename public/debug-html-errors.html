
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Error Page Debugger</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        .btn:hover {
            background: #0056b3;
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .error-frame {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 5px;
        }
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            position: relative;
            z-index: 1;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç HTML Error Page Debugger</h1>
        <p>Debug HTML error responses from your endpoints</p>

        <div class="test-section">
            <h3>Test Excel Endpoint</h3>
            <button class="btn" onclick="testExcelEndpoint()">Test /api/sqlite/existing-excel</button>
            <div class="output" id="excelOutput"></div>
        </div>

        <div class="test-section">
            <h3>Custom Endpoint Test</h3>
            <input type="text" id="customUrl" placeholder="/api/your-endpoint" style="width: 300px; padding: 8px;">
            <button class="btn" onclick="testCustomEndpoint()">Test Custom Endpoint</button>
            <div class="output" id="customOutput"></div>
        </div>

        <div class="test-section" id="errorSection" style="display: none;">
            <h3>üö® HTML Error Analysis</h3>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('raw')">Raw HTML</div>
                <div class="tab" onclick="showTab('rendered')">Rendered View</div>
                <div class="tab" onclick="showTab('parsed')">Parsed Info</div>
            </div>

            <div class="tab-content active" id="raw-content">
                <div class="output" id="rawHtml"></div>
            </div>

            <div class="tab-content" id="rendered-content">
                <iframe class="error-frame" id="errorFrame"></iframe>
            </div>

            <div class="tab-content" id="parsed-content">
                <div class="output" id="parsedInfo"></div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }

        async function makeRequest(url) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const contentType = response.headers.get('content-type') || '';
                const isHtml = contentType.includes('text/html');
                const isJson = contentType.includes('application/json');

                let data;
                if (isJson) {
                    data = await response.json();
                } else {
                    data = await response.text();
                }

                return {
                    response,
                    data,
                    isHtml,
                    isJson,
                    contentType,
                    status: response.status,
                    statusText: response.statusText
                };
            } catch (error) {
                return {
                    error: error.message,
                    isError: true
                };
            }
        }

        async function testExcelEndpoint() {
            const output = document.getElementById('excelOutput');
            output.textContent = 'Testing...';

            const result = await makeRequest('/api/sqlite/existing-excel');
            
            if (result.isError) {
                output.textContent = `‚ùå Network Error: ${result.error}`;
                return;
            }

            if (result.isHtml) {
                output.textContent = `üö® Received HTML instead of JSON!
Status: ${result.status} ${result.statusText}
Content-Type: ${result.contentType}

Click "Rendered View" tab below to see the error page.`;
                
                showErrorAnalysis(result.data, result);
            } else if (result.isJson) {
                output.textContent = `‚úÖ Received JSON response:
Status: ${result.status} ${result.statusText}
Content-Type: ${result.contentType}

${JSON.stringify(result.data, null, 2)}`;
            } else {
                output.textContent = `‚ö†Ô∏è Unexpected response type:
Status: ${result.status} ${result.statusText}
Content-Type: ${result.contentType}

${result.data}`;
            }
        }

        async function testCustomEndpoint() {
            const url = document.getElementById('customUrl').value;
            const output = document.getElementById('customOutput');
            
            if (!url) {
                output.textContent = 'Please enter an endpoint URL';
                return;
            }

            output.textContent = 'Testing...';
            const result = await makeRequest(url);
            
            if (result.isError) {
                output.textContent = `‚ùå Network Error: ${result.error}`;
                return;
            }

            if (result.isHtml) {
                output.textContent = `üö® Received HTML instead of JSON!
Status: ${result.status} ${result.statusText}
Content-Type: ${result.contentType}`;
                
                showErrorAnalysis(result.data, result);
            } else if (result.isJson) {
                output.textContent = `‚úÖ Received JSON response:
Status: ${result.status} ${result.statusText}

${JSON.stringify(result.data, null, 2)}`;
            } else {
                output.textContent = `Response:
Status: ${result.status} ${result.statusText}
Content-Type: ${result.contentType}

${result.data}`;
            }
        }

        function showErrorAnalysis(htmlContent, result) {
            document.getElementById('errorSection').style.display = 'block';
            
            // Raw HTML
            document.getElementById('rawHtml').textContent = htmlContent;
            
            // Rendered view
            const iframe = document.getElementById('errorFrame');
            iframe.srcdoc = htmlContent;
            
            // Parsed info
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            const title = doc.querySelector('title')?.textContent || 'No title';
            const h1 = doc.querySelector('h1')?.textContent || 'No h1';
            const errorMessages = Array.from(doc.querySelectorAll('p, div, span'))
                .map(el => el.textContent.trim())
                .filter(text => text && text.length > 10)
                .slice(0, 5);

            const parsedInfo = `üìã Error Page Analysis:

Title: ${title}
Main Heading: ${h1}
Status: ${result.status} ${result.statusText}
Content-Type: ${result.contentType}

Key Error Messages:
${errorMessages.map((msg, i) => `${i + 1}. ${msg}`).join('\n')}

üîç Common Issues to Check:
- Authentication: Is the user logged in?
- Authorization: Does user have permission?
- Route exists: Is the endpoint properly mounted?
- Middleware errors: Check authentication middleware
- Server errors: Check server logs
- Database connection: Is the database accessible?`;

            document.getElementById('parsedInfo').textContent = parsedInfo;
        }
    </script>
</body>
</html>
